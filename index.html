<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GymCoach — jouw vriendelijke coach</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#081028;--bg2:#071124;
      --glass: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.05);
      --accent-start:#7c3aed;--accent-end:#06b6d4;
      --muted: rgba(255,255,255,0.7);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Arial;color:#fff;
      background: radial-gradient(800px 400px at 10% 10%, rgba(7,99,246,0.06), transparent),
                 linear-gradient(180deg,var(--bg1),var(--bg2));
      -webkit-font-smoothing:antialiased; padding:28px;
      min-height:100vh; display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:100%;max-width:1100px;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border); box-shadow: 0 12px 40px rgba(2,6,23,0.6);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    main{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid var(--glass-border)}
    .ex-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .ex{padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:1px solid transparent;transition:all .12s}
    .ex:hover{transform:translateY(-3px);background:rgba(255,255,255,0.02)}
    .ex.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06));border-color: rgba(124,58,237,0.2)}

    .levels{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .level{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.start{background:linear-gradient(90deg,#10b981,#059669);color:white}
    .btn.pause{background:linear-gradient(90deg,#f59e0b,#f97316);color:white}
    .btn.stop{background:linear-gradient(90deg,#ef4444,#b91c1c);color:white}
    .btn.alt{background:rgba(255,255,255,0.03);color:var(--muted)}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid var(--glass-border)}
    .timer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid var(--glass-border)}
    .big{font-weight:900;font-size:30px}
    .history{max-height:180px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .hist-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;border:1px solid var(--glass-border)}

    .explain{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid var(--glass-border)}
    .spotify{margin-top:10px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="GymCoach app">
    <header>
      <div class="brand">
        <div class="logo">GC</div>
        <div>
          <h1>GymCoach — jouw vriendelijke coach</h1>
          <p class="lead">Langzaam opbouwen. Duidelijke uitleg. TTS die je helpt.</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="small" id="sessCount">Sessies: 0</div>
        <button class="btn alt" id="resetBtn" title="Reset alles">Reset</button>
      </div>
    </header>

    <main>
      <!-- LEFT -->
      <aside class="panel" aria-label="Keuzes">
        <h3 style="margin:0">Kies een oefening</h3>
        <div class="ex-list" id="exList"></div>

        <h3 style="margin-top:10px;margin-bottom:6px">Ervaring</h3>
        <div class="levels" id="levels"></div>

        <div style="margin-top:10px">
          <div class="small">Notities</div>
          <textarea id="notes" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;background:transparent;border:1px solid var(--glass-border);min-height:70px;color:inherit"></textarea>
        </div>

        <div style="margin-top:10px">
          <label class="small">Text-to-Speech</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <select id="voiceSelect" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid var(--glass-border)"></select>
            <button class="btn alt" id="ttsToggle">TTS: Aan</button>
          </div>
        </div>

        <div style="margin-top:10px" class="small">
          Spotify: plak link (optioneel)
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="spotifyInput" placeholder="https://open.spotify.com/..." style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid var(--glass-border)" />
            <button class="btn alt" id="saveSpotify">Opslaan</button>
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <section class="panel" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small" id="planFor">Plan: —</div>
            <div style="font-weight:800;font-size:18px" id="planTitle">Selecteer oefening</div>
            <div class="small" id="planHint">De coach past sets en reps aan op jouw niveau.</div>
          </div>
          <div style="text-align:right">
            <div class="small">Huidige set</div>
            <div style="font-weight:900;font-size:18px" id="currentSet">0 / 0</div>
            <div class="small" style="margin-top:6px">Timer</div>
            <div class="big" id="currentTimer">0:00</div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="small">Sets</div>
            <div style="font-weight:800;font-size:20px" id="planSets">—</div>
          </div>
          <div class="stat">
            <div class="small" id="planKind">Herhalingen</div>
            <div style="font-weight:800;font-size:20px" id="planReps">—</div>
          </div>
          <div class="stat">
            <div class="small">Rust (s)</div>
            <div style="font-weight:800;font-size:20px" id="planRest">—</div>
          </div>
          <div class="stat">
            <div class="small">Progressie</div>
            <div style="font-weight:700;color:var(--muted)">Elke 2 sessies iets zwaarder</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn start" id="startBtn">Start</button>
          <button class="btn pause" id="pauseBtn" disabled>Pauze</button>
          <button class="btn stop" id="stopBtn">Stop (nood)</button>
          <button class="btn alt" id="switchBtn">Iets anders</button>
          <button class="btn alt" id="completeBtn">Voltooid</button>
        </div>

        <div class="timer" role="status" aria-live="polite">
          <div>
            <div class="small">Motivatie</div>
            <div style="font-weight:800" id="motivation">Klaar om te starten — focus op techniek!</div>
          </div>
          <div style="text-align:right">
            <div class="small">Laatste sessie</div>
            <div id="lastSession" class="small">—</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 300px;gap:12px;margin-top:12px">
          <div>
            <div class="explain" id="explainBox">
              <strong>Uitleg oefening:</strong>
              <div id="explainText" style="margin-top:8px" class="small">Kies een oefening om uitleg te zien.</div>
            </div>
            <div class="spotify" id="spotifyWrap"></div>

            <div style="margin-top:12px">
              <h4 style="margin:0 0 8px 0">Extra uitleg & tips</h4>
              <div class="small" id="tips">
                De coach bouwt langzaam op afhankelijk van je niveau en hoeveel sessies je al hebt gedaan. Gebruik 'Voltooid' na een reps-set. Voor 'plank' gebruikt de coach een timer.
              </div>
            </div>
          </div>

          <aside>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h4 style="margin:0">Recente sessies</h4>
              <button class="btn alt" id="clearHist">Wis</button>
            </div>
            <div class="history" id="history"></div>
          </aside>
        </div>
      </section>
    </main>

    <footer style="margin-top:12px;text-align:center;color:var(--muted);font-size:12px">
      Gemaakt met liefde — upload `index.html` naar GitHub Pages. Wil je icons of extra oefeningen? Laat maar.
    </footer>
  </div>

<script>
/* GymCoach single-file: exercises + explanations + TTS
   LocalStorage keys: gym_v2_data, gym_v2_level, gym_v2_spotify
*/

(() => {
  // --- Data ---
  const EXERCISES = [
    { id: 'pushups', name: 'Opdrukken', type: 'reps',
      explain: `Opdrukken versterken borst, schouders en triceps. Houd lichaam recht, handen onder schouders, adem uit bij omhoog duwen. Doe de beweging gecontroleerd.` },
    { id: 'situps', name: 'Sit-ups', type: 'reps',
      explain: `Sit-ups richten op buikspieren. Buikspieren aanspannen, kin licht naar borst, kom omhoog met controle. Let op rug en nek; stop bij pijn.` },
    { id: 'plank', name: 'Planken', type: 'time',
      explain: `Plank traint core en houding. Houd lichaam in rechte lijn, ellebogen onder schouders, span buik en bilspieren. Adem door.` },
    { id: 'squats', name: 'Squats', type: 'reps',
      explain: `Squats trainen benen en bilspieren. Houd knieën boven voeten, rug recht, zak door je heupen. Zak niet dieper dan je mobiliteit toelaat.` },
    { id: 'burpees', name: 'Burpees', type: 'reps',
      explain: `Burpees zijn full-body cardio + kracht. Combineer squat, plank en sprong. Doe ze gecontroleerd en let op landingskracht.` }
  ];

  const LEVELS = [
    { id:'beginner', name:'Nieuw', factor:0.6, desc:'Rustig beginnen, focus op techniek.'},
    { id:'trained', name:'Getraint', factor:1.0, desc:'Je hebt ervaring.'},
    { id:'muscle', name:'Muscle guy', factor:1.4, desc:'Meer volume, voor kracht/massa.'},
    { id:'strongest', name:'Sterkste persoon op aarde', factor:1.9, desc:'Topniveau — build verstandig.'}
  ];

  const STORAGE = 'gym_v2_data';
  const LEVEL_KEY = 'gym_v2_level';
  const SPOT_KEY = 'gym_v2_spotify';

  // --- Elements ---
  const exListEl = document.getElementById('exList');
  const levelsEl = document.getElementById('levels');
  const planTitle = document.getElementById('planTitle');
  const planFor = document.getElementById('planFor');
  const planSets = document.getElementById('planSets');
  const planReps = document.getElementById('planReps');
  const planRest = document.getElementById('planRest');
  const planKind = document.getElementById('planKind');
  const currentSet = document.getElementById('currentSet');
  const currentTimer = document.getElementById('currentTimer');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const switchBtn = document.getElementById('switchBtn');
  const completeBtn = document.getElementById('completeBtn');
  const explainText = document.getElementById('explainText');
  const motivation = document.getElementById('motivation');
  const sessCount = document.getElementById('sessCount');
  const historyEl = document.getElementById('history');
  const lastSessionEl = document.getElementById('lastSession');
  const notesEl = document.getElementById('notes');
  const resetBtn = document.getElementById('resetBtn');
  const spotifyInput = document.getElementById('spotifyInput');
  const saveSpotify = document.getElementById('saveSpotify');
  const spotifyWrap = document.getElementById('spotifyWrap');
  const voiceSelect = document.getElementById('voiceSelect');
  const ttsToggle = document.getElementById('ttsToggle');
  const clearHist = document.getElementById('clearHist');

  // --- State ---
  let user = loadUser();
  let selectedEx = EXERCISES[0].id;
  let selectedLevel = localStorage.getItem(LEVEL_KEY) || 'beginner';
  let plan = null;
  let timers = { interval:null, remaining:0 };
  let curRound = 0;
  let sessionActive = false;
  let ttsEnabled = true;
  let spotifyURI = localStorage.getItem(SPOT_KEY) || '';

  // --- Init ---
  function init(){
    // render exercises
    EXERCISES.forEach(ex => {
      const el = document.createElement('div');
      el.className = 'ex';
      el.dataset.id = ex.id;
      el.innerHTML = `<div><div style="font-weight:700">${ex.name}</div><div class="small">${ex.type==='time'?'Duur':'Herhalingen'}</div></div><div class="small">></div>`;
      el.addEventListener('click', ()=> { stopWorkout(); selectedEx = ex.id; render(); });
      exListEl.appendChild(el);
    });

    // render levels
    LEVELS.forEach(l => {
      const lab = document.createElement('label');
      lab.className = 'level';
      lab.innerHTML = `<input type="radio" name="lvl" value="${l.id}" ${l.id===selectedLevel?'checked':''}/> <div style="margin-left:8px"><div style="font-weight:700">${l.name}</div><div class="small">${l.desc}</div></div>`;
      lab.querySelector('input').addEventListener('change', ()=>{ selectedLevel = l.id; localStorage.setItem(LEVEL_KEY, selectedLevel); stopWorkout(); render(); });
      levelsEl.appendChild(lab);
    });

    // buttons
    startBtn.addEventListener('click', startOrResume);
    pauseBtn.addEventListener('click', pauseWorkout);
    stopBtn.addEventListener('click', ()=>{ stopWorkout(); speakSafe('Workout gestopt'); showToast('Workout gestopt'); });
    switchBtn.addEventListener('click', ()=>{ const i = EXERCISES.findIndex(e=>e.id===selectedEx); selectedEx = EXERCISES[(i+1)%EXERCISES.length].id; stopWorkout(); render(); });
    completeBtn.addEventListener('click', completeSet);
    resetBtn.addEventListener('click', ()=>{ if(confirm('Reset alle data?')) { localStorage.removeItem(STORAGE); localStorage.removeItem(LEVEL_KEY); localStorage.removeItem(SPOT_KEY); location.reload(); } });
    saveSpotify.addEventListener('click', ()=>{ spotifyURI = spotifyInput.value.trim(); localStorage.setItem(SPOT_KEY, spotifyURI); renderSpotify(); showToast('Spotify opgeslagen'); });
    clearHist.addEventListener('click', ()=>{ if(confirm('Wis geschiedenis?')) { user.history=[]; user.sessions=0; saveUser(); render(); } });

    notesEl.value = user.lastNotes || '';
    notesEl.addEventListener('input', ()=>{ user.lastNotes = notesEl.value; saveUser(); });

    // TTS voices
    populateVoices();
    window.speechSynthesis.onvoiceschanged = populateVoices;
    ttsToggle.addEventListener('click', ()=>{ ttsEnabled = !ttsEnabled; ttsToggle.textContent = 'TTS: ' + (ttsEnabled ? 'Aan' : 'Uit'); });

    spotifyInput.value = spotifyURI;
    render();
  }

  function populateVoices(){
    const voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('nl') || v.lang.startsWith('en')).sort((a,b)=> a.name.localeCompare(b.name));
    voiceSelect.innerHTML = '';
    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSelect.appendChild(opt);
    });
    // choose default if available
    const saved = localStorage.getItem('gym_v2_voice');
    if (saved) voiceSelect.value = saved;
    voiceSelect.addEventListener('change', ()=> localStorage.setItem('gym_v2_voice', voiceSelect.value));
  }

  // --- Persistence ---
  function loadUser(){
    try { const raw = localStorage.getItem(STORAGE); if(raw) return JSON.parse(raw); } catch(e){}
    return { sessions:0, history:[], lastNotes:'' };
  }
  function saveUser(){ localStorage.setItem(STORAGE, JSON.stringify(user)); sessCount.textContent = 'Sessies: '+(user.sessions||0); }

  // --- Plan generator ---
  function generatePlan(exId, lvlId){
    const ex = EXERCISES.find(e=>e.id===exId);
    const lvl = LEVELS.find(l=>l.id===lvlId) || LEVELS[0];
    const base = { reps:{sets:3,reps:8,rest:60}, time:{sets:3,duration:20,rest:45} };
    const tpl = ex.type==='time'?base.time:base.reps;
    const sessions = user.sessions || 0;
    const prog = 1 + Math.min(0.12*Math.floor(sessions/2), 1);
    const lf = lvl.factor;
    const sets = Math.max(1, Math.round(tpl.sets*lf));
    const repDur = ex.type==='time'? Math.max(10, Math.round(tpl.duration*lf*prog)) : Math.max(1, Math.round(tpl.reps*lf*prog));
    const rest = Math.max(12, Math.round(tpl.rest/(1+Math.floor(sessions/6)*0.05)));
    return { exercise:ex, level:lvl, sets, repDur, rest, created:new Date().toISOString() };
  }

  // --- Render ---
  function render(){
    document.querySelectorAll('.ex').forEach(el=> el.classList.toggle('active', el.dataset.id===selectedEx));
    plan = generatePlan(selectedEx, selectedLevel);
    planTitle.textContent = plan.exercise.name;
    planFor.textContent = `Voor: ${plan.exercise.name} — Niveau: ${plan.level.name}`;
    planSets.textContent = plan.sets;
    planReps.textContent = plan.repDur;
    planRest.textContent = plan.rest;
    planKind.textContent = plan.exercise.type==='time' ? 'Duur (s)' : 'Herhalingen';
    explainText.textContent = plan.exercise.explain;
    motivation.textContent = motivationText(user.sessions||0);
    sessCount.textContent = 'Sessies: ' + (user.sessions||0);
    renderHistory();
    renderSpotify();
    currentSet.textContent = `${curRound} / ${plan.sets}`;
    currentTimer.textContent = formatTime(timers.remaining || 0);
    // show/hide 'Voltooid' depending on type
    completeBtn.style.display = plan.exercise.type === 'reps' ? 'inline-block' : 'none';
    lastSessionEl.textContent = user.history && user.history.length ? new Date(user.history[0].when).toLocaleString() : '—';
  }

  function renderHistory(){
    historyEl.innerHTML = '';
    (user.history||[]).slice(0,10).forEach(h => {
      const exName = EXERCISES.find(e=>e.id===h.exercise)?.name || h.exercise;
      const el = document.createElement('div'); el.className='hist-item';
      el.innerHTML = `<div style="font-weight:700">${exName} — ${h.level}</div><div class="small">${new Date(h.when).toLocaleString()}</div><div class="small" style="margin-top:6px;color:var(--muted)">${h.notes||''}</div>`;
      historyEl.appendChild(el);
    });
  }

  function renderSpotify(){
    spotifyWrap.innerHTML = '';
    if(!spotifyURI){ spotifyWrap.innerHTML = '<div class="small" style="color:var(--muted)">Geen Spotify embed</div>'; return; }
    const embed = spotifyEmbed(spotifyURI);
    if(!embed){ spotifyWrap.innerHTML = '<div class="small" style="color:var(--muted)">Ongeldige Spotify link</div>'; return; }
    const iframe = document.createElement('iframe');
    iframe.src = embed; iframe.width='100%'; iframe.height='80'; iframe.frameBorder='0'; iframe.allow='autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
    spotifyWrap.appendChild(iframe);
  }

  // --- Controls / Timer logic ---
  function startOrResume(){
    if(!plan) return;
    if(!sessionActive){
      // start a set
      if(plan.exercise.type === 'time'){
        startTimeSet(plan.repDur);
      } else {
        // reps-based: user does reps and presses Voltooid
        curRound = Math.min(plan.sets, curRound+1);
        sessionActive = true;
        timers.remaining = 0;
        updateUI();
        speakSafe(`Set ${curRound} gestart: ${plan.repDur} herhalingen`);
        saveNotes();
      }
    } else {
      // resume if paused and timer present
      if(timers.interval === null && timers.remaining > 0){
        continueTimer();
      }
    }
  }

  function startTimeSet(seconds){
    clearInterval(timers.interval);
    timers.remaining = seconds;
    curRound = Math.min(plan.sets, curRound+1);
    sessionActive = true;
    updateUI();
    speakSafe(`Start ${plan.exercise.name} voor ${seconds} seconden`);
    runCountdown();
    saveNotes();
  }

  function runCountdown(){
    updateUI();
    timers.interval = setInterval(()=>{
      timers.remaining = Math.max(0, timers.remaining-1);
      updateUI();
      if(timers.remaining <= 0){
        clearInterval(timers.interval); timers.interval = null;
        // after set -> rest or finish
        startRestOrNext();
      }
    }, 1000);
  }

  function continueTimer(){
    if(timers.interval) return;
    timers.interval = setInterval(()=>{
      timers.remaining = Math.max(0, timers.remaining-1);
      updateUI();
      if(timers.remaining <= 0){ clearInterval(timers.interval); timers.interval = null; startRestOrNext(); }
    }, 1000);
    updateUI();
  }

  function startRestOrNext(){
    if(curRound < plan.sets){
      timers.remaining = plan.rest;
      speakSafe(`Rust nu ${plan.rest} seconden`);
      updateUI();
      timers.interval = setInterval(()=>{
        timers.remaining = Math.max(0, timers.remaining-1); updateUI();
        if(timers.remaining <= 0){ clearInterval(timers.interval); timers.interval = null; 
          // start next
          if(plan.exercise.type === 'time') startTimeSet(plan.repDur);
          else { curRound = Math.min(plan.sets, curRound+1); sessionActive = true; updateUI(); speakSafe(`Set ${curRound} gestart`); }
        }
      },1000);
    } else {
      finishSession();
    }
  }

  function pauseWorkout(){
    if(timers.interval){ clearInterval(timers.interval); timers.interval = null; }
    sessionActive = false;
    updateUI();
    speakSafe('Pauze');
  }

  function stopWorkout(){
    if(timers.interval){ clearInterval(timers.interval); timers.interval = null; }
    sessionActive = false;
    timers.remaining = 0; curRound = 0;
    updateUI();
  }

  function completeSet(){
    if(!plan || plan.exercise.type === 'time') return;
    if(!sessionActive) return;
    // end this set -> start rest or finish
    if(curRound < plan.sets){
      timers.remaining = plan.rest;
      updateUI();
      speakSafe(`Rust nu ${plan.rest} seconden`);
      if(timers.interval) clearInterval(timers.interval);
      timers.interval = setInterval(()=>{
        timers.remaining = Math.max(0, timers.remaining-1); updateUI();
        if(timers.remaining <= 0){ clearInterval(timers.interval); timers.interval=null;
          if(curRound < plan.sets) { curRound = Math.min(plan.sets, curRound+1); sessionActive = true; updateUI(); speakSafe(`Set ${curRound} gestart`); }
          else finishSession();
        }
      },1000);
    } else {
      finishSession();
    }
  }

  function finishSession(){
    // save
    const entry = { exercise: plan.exercise.id, level: plan.level.id, sets: plan.sets, repsOrDuration: plan.repDur, when: new Date().toISOString(), notes: notesEl.value||'' };
    user.history = [entry, ...(user.history||[])].slice(0,50);
    user.sessions = (user.sessions||0) + 1;
    saveUser();
    sessionActive = false; timers.remaining = 0; curRound = 0; updateUI(); render();
    speakSafe('Goed gedaan! Sessie afgerond.');
    showToast('Sessie opgeslagen — goed bezig!');
  }

  function updateUI(){
    currentSet.textContent = `${curRound} / ${plan?plan.sets:0}`;
    currentTimer.textContent = formatTime(timers.remaining || 0);
    pauseBtn.disabled = !sessionActive;
    completeBtn.style.display = plan && plan.exercise.type==='reps' && sessionActive ? 'inline-block' : 'none';
  }

  // --- Helpers ---
  function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
  function motivationText(s){ if(s<3) return 'Top start! Focus op techniek.'; if(s<10) return 'Goed bezig — kleine stapjes.'; if(s<30) return 'Awesome progress!'; return 'Je bent beest — blijf smart.'; }
  function saveNotes(){ user.lastNotes = notesEl.value||''; saveUser(); }

  function renderToastEl(){ /* simple fallback */ }

  function showToast(msg){ // quick visual via motivation
    const prev = motivation.textContent;
    motivation.textContent = msg;
    setTimeout(()=> motivation.textContent = motivationText(user.sessions||0), 2600);
  }

  function renderHistory(){ render(); } // already handled in render()

  // --- Spotify helper ---
  function spotifyEmbed(uri){
    if(!uri) return '';
    try{
      if(uri.startsWith('spotify:')){ const p=uri.split(':'); return `https://open.spotify.com/embed/${p[1]}/${p[2]}`; }
      const u = new URL(uri);
      if(u.hostname.includes('spotify.com')){ const parts = u.pathname.split('/').filter(Boolean); if(parts.length>=2) return `https://open.spotify.com/embed/${parts[0]}/${parts[1]}`; }
    }catch(e){}
    return '';
  }

  // --- TTS ---
  function speakSafe(text){
    if(!ttsEnabled) return;
    try{
      const utter = new SpeechSynthesisUtterance(text);
      // choose voice if saved
      const preferred = localStorage.getItem('gym_v2_voice');
      if(preferred){
        const v = speechSynthesis.getVoices().find(x=>x.name===preferred);
        if(v) utter.voice = v;
      }
      utter.lang = 'nl-NL';
      speechSynthesis.cancel(); // avoid overlapping
      speechSynthesis.speak(utter);
    }catch(e){}
  }

  function formatTimeReadable(sec){
    return sec + ' seconden';
  }

  // --- Utilities ---
  function loadPlanAndRender(){
    plan = generatePlan(selectedEx, selectedLevel);
    render();
  }

  // --- Start app ---
  init();
  loadPlanAndRender();
  saveUser();

  // expose small debug API
  window.GymCoach = { getUser: ()=>user, reset: ()=>{ localStorage.removeItem(STORAGE); localStorage.removeItem(LEVEL_KEY); localStorage.removeItem(SPOT_KEY); location.reload(); } };

})();
</script>
</body>
</html>
